import React, { useState } from 'react';
import { MsalProvider, useMsal, useIsAuthenticated } from '@azure/msal-react';
import { PublicClientApplication } from '@azure/msal-browser';
import { msalConfig } from './msalConfig';
import { useVideoGeneration } from './hooks/useVideoGeneration';
import { useImageGeneration } from './hooks/useImageGeneration';
import { useImageEdit } from './hooks/useImageEdit';
import VideoGenerationPanel from './components/VideoGenerationPanel';
import ImageGenerationPanel from './components/ImageGenerationPanel';
import ImageEditPanel from './components/ImageEditPanel';
import ImageHistoryPanel from './components/ImageHistoryPanel';
import VideoHistoryPanel from './VideoHistoryPanel';
import './App.css';

// ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰å®šç¾©
type AppMode = 'generate' | 'edit' | 'video';

const msalInstance = new PublicClientApplication(msalConfig);

function AppContent() {
  const isAuthenticated = useIsAuthenticated();
  const { instance } = useMsal();

  // ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰ç®¡ç†
  const [currentMode, setCurrentMode] = useState<AppMode>('generate');

  // hooks ã‚’ä½¿ç”¨
  const videoHooks = useVideoGeneration();
  const imageHooks = useImageGeneration();
  const editHooks = useImageEdit();

  // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆ
  if (!isAuthenticated) {
    return (
      <div className="modal-overlay">
        <div className="modal-content">
          <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h2>
          <p>ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯Microsoft Entra IDã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
          <button 
            className="login-modal-btn" 
            onClick={() => instance.loginPopup()}
          >
            ğŸ“ ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      </div>
    );
  }

  // ãƒ¡ã‚¤ãƒ³UI
  return (
    <div className="App">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="header">
        <div className="header-content">
          <h1 className="logo">ğŸ¨ ImageOne - AIç”»åƒãƒ»å‹•ç”»ç”Ÿæˆ</h1>
          
          {/* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */}
          <div className="mode-tabs">
            <button
              className={`mode-tab ${currentMode === 'generate' ? 'active' : ''}`}
              onClick={() => setCurrentMode('generate')}
            >
              ğŸ­ ç”»åƒç”Ÿæˆ
            </button>
            <button
              className={`mode-tab ${currentMode === 'edit' ? 'active' : ''}`}
              onClick={() => setCurrentMode('edit')}
            >
              ğŸ–¼ï¸ ç”»åƒç·¨é›†
            </button>
            <button
              className={`mode-tab ${currentMode === 'video' ? 'active' : ''}`}
              onClick={() => setCurrentMode('video')}
            >
              ğŸ¬ å‹•ç”»ç”Ÿæˆ
            </button>
          </div>
          
          {/* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ */}
          <button 
            onClick={() => instance.logoutPopup()}
            className="logout-btn"
          >
            ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
          </button>
        </div>
      </div>

      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="content">
        {/* å·¦å´ï¼šãƒ‘ãƒãƒ« */}
        <div className="main-panel">
          {currentMode === 'generate' && (
            <ImageGenerationPanel
              prompt={imageHooks.prompt}
              setPrompt={imageHooks.setPrompt}
              originalPrompt={imageHooks.originalPrompt}
              size={imageHooks.size}
              setSize={imageHooks.setSize}
              loading={imageHooks.loading}
              loadingRec={imageHooks.loadingRec}
              recommendedPrompt={imageHooks.recommendedPrompt}
              cameraSettings={imageHooks.cameraSettings}
              setCameraSettings={imageHooks.setCameraSettings}
              onImageGenerate={imageHooks.handleImageGenerate}
              onGenerateRecommended={imageHooks.generateRecommendedPrompt}
              onUseRecommendedPrompt={imageHooks.useRecommendedPrompt}
            />
          )}

          {currentMode === 'edit' && (
            <ImageEditPanel
              editPrompt={editHooks.editPrompt}
              setEditPrompt={editHooks.setEditPrompt}
              uploadedImage={editHooks.uploadedImage}
              editedImage={editHooks.editedImage}
              loading={editHooks.loading}
              detectedSize={editHooks.detectedSize}
              canvasRef={editHooks.canvasRef}
              isDrawing={editHooks.isDrawing}
              hasMask={editHooks.hasMask}
              onImageUpload={editHooks.handleImageUpload}
              onImageEdit={editHooks.handleImageEdit}
              onResetEdit={editHooks.resetEdit}
              startDrawing={editHooks.startDrawing}
              draw={editHooks.draw}
              stopDrawing={editHooks.stopDrawing}
              clearMask={editHooks.clearMask}
            />
          )}

          {currentMode === 'video' && (
            <VideoGenerationPanel
              videoPrompt={videoHooks.videoPrompt}
              setVideoPrompt={videoHooks.setVideoPrompt}
              videoAspectRatio={videoHooks.videoAspectRatio}
              setVideoAspectRatio={videoHooks.setVideoAspectRatio}
              videoResolution={videoHooks.videoResolution}
              setVideoResolution={videoHooks.setVideoResolution}
              videoDuration={videoHooks.videoDuration}
              setVideoDuration={videoHooks.setVideoDuration}
              videoVariation={videoHooks.videoVariation}
              setVideoVariation={videoHooks.setVideoVariation}
              videoLoading={videoHooks.videoLoading}
              loadingRec={videoHooks.loadingRec}
              recommendedPrompt={videoHooks.recommendedPrompt}
              onVideoGenerate={videoHooks.handleVideoGenerate}
              onGenerateRecommended={videoHooks.generateRecommendedVideo}
              onUseRecommendedPrompt={videoHooks.useRecommendedPrompt}
            />
          )}
        </div>

        {/* å³å´ï¼šå±¥æ­´ãƒ‘ãƒãƒ« */}
        <div className="history-panel">
          {(currentMode === 'generate' || currentMode === 'edit') && (
            <ImageHistoryPanel
              imageHistory={imageHooks.imageHistory}
              selectedImage={imageHooks.selectedImage}
              loading={imageHooks.imageHistoryLoading}
              onRefresh={imageHooks.handleImageHistoryRefresh}
              onImageSelect={imageHooks.handleImageSelect}
              onImageDelete={imageHooks.handleImageDelete}
            />
          )}

          {currentMode === 'video' && (
            <VideoHistoryPanel
              videoJobs={videoHooks.videoJobs}
              onDeleteJob={(jobId: string) => {
                const job = videoHooks.videoJobs.find(j => j.id === jobId);
                if (job) {
                  videoHooks.deleteJob(job);
                }
              }}
            />
          )}
        </div>
      </div>
    </div>
  );
}

export default function App() {
  return (
    <MsalProvider instance={msalInstance}>
      <AppContent />
    </MsalProvider>
  );
}
