import React, { useState } from 'react';
import { MsalProvider, useMsal, useIsAuthenticated } from '@azure/msal-react';
import { PublicClientApplication } from '@azure/msal-browser';
import { msalConfig } from './msalConfig';
import { useVideoGeneration } from './hooks/useVideoGeneration';
import { useImageGeneration } from './hooks/useImageGeneration';
import { useImageEdit } from './hooks/useImageEdit';
import VideoGenerationPanel from './components/VideoGenerationPanel';
import ImageGenerationPanel from './components/ImageGenerationPanel';
import ImageEditPanel from './components/ImageEditPanel';
import ImageHistoryPanel from './components/ImageHistoryPanel';
import VideoHistoryPanel from './VideoHistoryPanel';
import './App.css';

// ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰å®šç¾©
type AppMode = 'generate' | 'edit' | 'video';

const msalInstance = new PublicClientApplication(msalConfig);

function AppContent() {
  const isAuthenticated = useIsAuthenticated();
  const { instance } = useMsal();

  // ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰ç®¡ç†
  const [currentMode, setCurrentMode] = useState<AppMode>('generate');

  // hooks ã‚’ä½¿ç”¨
  const videoHooks = useVideoGeneration();
  const imageHooks = useImageGeneration();
  const editHooks = useImageEdit();

  // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆ
  if (!isAuthenticated) {
    return (
      <div className="modal-overlay">
        <div className="modal-content">
          <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h2>
          <p>ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯Microsoft Entra IDã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
          <button 
            className="login-modal-btn" 
            onClick={() => instance.loginPopup()}
          >
            ğŸ“ ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      </div>
    );
  }

  // ãƒ¡ã‚¤ãƒ³UI
  return (
    <div className="App">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="header">
        <div className="header-content">
          <h1 className="logo">ğŸ¨ ImageOne - AIç”»åƒãƒ»å‹•ç”»ç”Ÿæˆ</h1>
          
          {/* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– */}
          <div className="mode-tabs">
            <button
              className={`mode-tab ${currentMode === 'generate' ? 'active' : ''}`}
              onClick={() => setCurrentMode('generate')}
            >
              ğŸ­ ç”»åƒç”Ÿæˆ
            </button>
            <button
              className={`mode-tab ${currentMode === 'edit' ? 'active' : ''}`}
              onClick={() => setCurrentMode('edit')}
            >
              ğŸ–¼ï¸ ç”»åƒç·¨é›†
            </button>
            <button
              className={`mode-tab ${currentMode === 'video' ? 'active' : ''}`}
              onClick={() => setCurrentMode('video')}
            >
              ğŸ¬ å‹•ç”»ç”Ÿæˆ
            </button>
          </div>
          
          {/* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ */}
          <button 
            onClick={() => instance.logoutPopup()}
            className="logout-btn"
          >
            ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
          </button>
        </div>
      </div>

      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="content">
        {/* å·¦å´ï¼šãƒ‘ãƒãƒ« */}
        <div className="main-panel">
          {currentMode === 'generate' && (
            <ImageGenerationPanel
              prompt={imageHooks.prompt}
              setPrompt={imageHooks.setPrompt}
              originalPrompt={imageHooks.originalPrompt}
              size={imageHooks.size}
              setSize={imageHooks.setSize}
              loading={imageHooks.loading}
              generateImage={imageHooks.generateImage}
            />
          )}

          {currentMode === 'edit' && (
            <ImageEditPanel
              prompt={editHooks.prompt}
              setPrompt={editHooks.setPrompt}
              originalPrompt={editHooks.originalPrompt}
              size={editHooks.size}
              setSize={editHooks.setSize}
              loading={editHooks.loading}
              generateImage={editHooks.generateImage}
              image={editHooks.image}
              setImage={editHooks.setImage}
              imageUrl={editHooks.imageUrl}
              setImageUrl={editHooks.setImageUrl}
            />
          )}

          {currentMode === 'video' && (
            <VideoGenerationPanel
              prompt={videoHooks.prompt}
              setPrompt={videoHooks.setPrompt}
              originalPrompt={videoHooks.originalPrompt}
              size={videoHooks.size}
              setSize={videoHooks.setSize}
              loading={videoHooks.loading}
              generateVideo={videoHooks.generateVideo}
            />
          )}
        </div>

        {/* å³å´ï¼šå±¥æ­´ãƒ‘ãƒãƒ« */}
        <div className="history-panel">
          {currentMode === 'generate' && (
            <ImageHistoryPanel
              images={imageHooks.images}
              onDelete={imageHooks.deleteImage}
            />
          )}

          {currentMode === 'edit' && (
            <ImageHistoryPanel
              images={editHooks.images}
              onDelete={editHooks.deleteImage}
            />
          )}

          {currentMode === 'video' && (
            <VideoHistoryPanel
              videoJobs={videoHooks.videoJobs}
              onDeleteJob={videoHooks.deleteVideoJob}
            />
          )}
        </div>
      </div>
    </div>
  );
}

export default function App() {
  return (
    <MsalProvider instance={msalInstance}>
      <AppContent />
    </MsalProvider>
  );
}
              loadingRec={imageHooks.loadingRec}
              recommendedPrompt={imageHooks.recommendedPrompt}
              cameraSettings={imageHooks.cameraSettings}
              setCameraSettings={imageHooks.setCameraSettings}
              onImageGenerate={imageHooks.handleImageGenerate}
              onGenerateRecommended={imageHooks.generateRecommendedPrompt}
              onUseRecommendedPrompt={imageHooks.useRecommendedPrompt}
            />
          )}
          
          {currentMode === 'edit' && (
            <ImageEditPanel
              editPrompt={editHooks.editPrompt}
              setEditPrompt={editHooks.setEditPrompt}
              uploadedImage={editHooks.uploadedImage}
              editedImage={editHooks.editedImage}
              loading={editHooks.loading}
              detectedSize={editHooks.detectedSize}
              canvasRef={editHooks.canvasRef}
              isDrawing={editHooks.isDrawing}
              hasMask={editHooks.hasMask}
              onImageUpload={editHooks.handleImageUpload}
              onImageEdit={editHooks.handleImageEdit}
              onResetEdit={editHooks.resetEdit}
              startDrawing={editHooks.startDrawing}
              draw={editHooks.draw}
              stopDrawing={editHooks.stopDrawing}
              clearMask={editHooks.clearMask}
            />
          )}
          
          {currentMode === 'video' && (
            <VideoGenerationPanel
              videoPrompt={videoHooks.videoPrompt}
              setVideoPrompt={videoHooks.setVideoPrompt}
              videoAspectRatio={videoHooks.videoAspectRatio}
              setVideoAspectRatio={videoHooks.setVideoAspectRatio}
              videoResolution={videoHooks.videoResolution}
              setVideoResolution={videoHooks.setVideoResolution}
              videoDuration={videoHooks.videoDuration}
              setVideoDuration={videoHooks.setVideoDuration}
              videoVariation={videoHooks.videoVariation}
              setVideoVariation={videoHooks.setVideoVariation}
              videoLoading={videoHooks.videoLoading}
              loadingRec={videoHooks.loadingRec}
              recommendedPrompt={videoHooks.recommendedPrompt}
              onVideoGenerate={videoHooks.handleVideoGenerate}
              onGenerateRecommended={videoHooks.generateRecommendedVideo}
              onUseRecommendedPrompt={videoHooks.useRecommendedPrompt}
            />
          )}

          {/* ç”Ÿæˆçµæœè¡¨ç¤º */}
          {currentMode === 'generate' && imageHooks.generatedImage && (
            <div className="generated-image-section">
              <h3>âœ¨ ç”Ÿæˆã•ã‚ŒãŸç”»åƒ</h3>
              <img 
                src={imageHooks.generatedImage} 
                alt="ç”Ÿæˆã•ã‚ŒãŸç”»åƒ" 
                className="generated-image"
                onClick={() => imageHooks.handleImageSelect({ 
                  id: 'current',
                  prompt: imageHooks.prompt,
                  imageUrl: imageHooks.generatedImage!,
                  operationType: 'generate',
                  size: imageHooks.size,
                  timestamp: new Date().toISOString()
                })}
              />
            </div>
          )}
          
          {currentMode === 'edit' && editHooks.editedImage && (
            <div className="edited-image-section">
              <h3>ğŸ¨ ç·¨é›†çµæœ</h3>
              <img 
                src={editHooks.editedImage} 
                alt="ç·¨é›†ã•ã‚ŒãŸç”»åƒ" 
                className="edited-image"
              />
            </div>
          )}

          {/* é¸æŠã•ã‚ŒãŸç”»åƒã®è©³ç´°è¡¨ç¤º */}
          {(currentMode === 'generate' || currentMode === 'edit') && imageHooks.selectedImage && (
            <div className="selected-image-section">
              <div className="image-player-header">
                <h3>ğŸ–¼ï¸ é¸æŠä¸­ã®ç”»åƒ</h3>
                <button 
                  className="close-btn"
                  onClick={() => imageHooks.handleImageSelect(null)}
                >
                  âœ•
                </button>
              </div>
              <div className="large-image-container">
                <img 
                  src={imageHooks.selectedImage.imageUrl} 
                  alt={imageHooks.selectedImage.prompt}
                  className="large-image"
                />
                <div className="large-image-info">
                  <div className="image-prompt">
                    <strong>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</strong> {imageHooks.selectedImage.prompt}
                  </div>
                  <div className="image-details">
                    ğŸ“ {imageHooks.selectedImage.size} â€¢ 
                    {imageHooks.selectedImage.operationType === 'generate' ? 'ğŸ¨ ç”Ÿæˆ' : 'âœï¸ ç·¨é›†'} â€¢ 
                    ğŸ•’ {new Date(imageHooks.selectedImage.timestamp).toLocaleString()}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */}
          {currentMode === 'video' && videoHooks.selectedVideo && (
            <div className="video-player-section">
              <div className="video-player-header">
                <h3>â–¶ï¸ å†ç”Ÿä¸­ã®å‹•ç”»</h3>
                <button 
                  className="close-btn"
                  onClick={() => videoHooks.handleVideoSelect(null)}
                >
                  âœ•
                </button>
              </div>
              <div className="large-video-player-container">
                <video 
                  controls 
                  className="large-video-player"
                  key={videoHooks.selectedVideo.id}
                  autoPlay
                >
                  <source src={videoHooks.selectedVideo.videoUrl} type="video/mp4" />
                  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                </video>
                <div className="large-video-player-info">
                  <div className="video-player-prompt">
                    <strong>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</strong> {videoHooks.selectedVideo.prompt}
                  </div>
                  <div className="video-player-details">
                    ğŸ“ {videoHooks.selectedVideo.videoSettings.width}Ã—{videoHooks.selectedVideo.videoSettings.height} â€¢ 
                    â±ï¸ {videoHooks.selectedVideo.videoSettings.n_seconds}ç§’
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* å³å´ï¼šå±¥æ­´ãƒ‘ãƒãƒ« */}
        <div className="side-panel">
          <h3>
            {currentMode === 'video' ? 'ğŸ¬ å‹•ç”»å±¥æ­´' : 'ğŸ’¾ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå±¥æ­´'}
          </h3>
          
          {(currentMode === 'generate' || currentMode === 'edit') && (
            <ImageHistoryPanel
              imageHistory={imageHooks.imageHistory}
              selectedImage={imageHooks.selectedImage}
              loading={imageHooks.imageHistoryLoading}
              onRefresh={imageHooks.handleImageHistoryRefresh}
              onImageSelect={imageHooks.handleImageSelect}
              onImageDelete={imageHooks.handleImageDelete}
            />
          )}
          
          {currentMode === 'video' && (
            <VideoHistoryPanel
              videoJobs={videoHooks.videoJobs}
              onDeleteJob={(jobId: string) => {
                const job = videoHooks.videoJobs.find(j => j.id === jobId);
                if (job) {
                  videoHooks.deleteJob(job);
                }
              }}
            />
          )}
        </div>
      </div>
    </div>
  );
}

function App() {
  return (
    <MsalProvider instance={msalInstance}>
      <AppContent />
    </MsalProvider>
  );
}

export default App;
