// App.tsx - çµ±åˆç‰ˆ: ç”»åƒç”Ÿæˆãƒ»ç·¨é›†ãƒ»å‹•ç”»ç”Ÿæˆã®3ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
import React, { useState, useEffect, ChangeEvent, useRef, useCallback } from 'react';
import { MsalProvider, useMsal, useIsAuthenticated } from '@azure/msal-react';
import { PublicClientApplication } from '@azure/msal-browser';
import { msalConfig } from './msalConfig';
import { useVideoGeneration } from './hooks/useVideoGeneration';
import VideoGenerationPanel from './components/VideoGenerationPanel';
import { PromptHistoryItem } from './types';
import './App.css';

// ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰å®šç¾©
type AppMode = 'generate' | 'edit' | 'video-generation';

const msalInstance = new PublicClientApplication(msalConfig);

function AuthButtons() {
  const { instance } = useMsal();
  const isAuthenticated = useIsAuthenticated();

  if (isAuthenticated) {
    return (
      <div style={{ 
        position: 'absolute', 
        top: '10px', 
        right: '10px', 
        zIndex: 1000 
      }}>
        <button 
          onClick={() => instance.logoutPopup()}
          style={{
            padding: '8px 16px',
            backgroundColor: '#d32f2f',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer'
          }}
        >
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    );
  }

  return null;
}

function AppContent() {
  const isAuthenticated = useIsAuthenticated();
  const { instance } = useMsal();

  // ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ‰ç®¡ç†
  const [currentMode, setCurrentMode] = useState<AppMode>('image-generation');

  // ğŸ¬ å‹•ç”»ç”Ÿæˆé–¢é€£ã®hookã‚’ä½¿ç”¨
  const videoHooks = useVideoGeneration();

  // ğŸ­ ç”»åƒç”Ÿæˆé–¢é€£ã®hookã‚’ä½¿ç”¨
  const imageHooks = useImageGeneration();

  // ğŸ–¼ï¸ ç”»åƒç·¨é›†é–¢é€£ã®hookã‚’ä½¿ç”¨
  const editHooks = useImageEdit();

  // ğŸ¨ ç”»åƒç”ŸæˆæˆåŠŸå¾Œã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆå±¥æ­´æ›´æ–°ä»˜ãï¼‰
  const handleImageGenerateWithRefresh = async () => {
    await imageHooks.handleImageGenerate();
    // ç”»åƒç”ŸæˆãŒæˆåŠŸã—ãŸã‚‰å±¥æ­´ã‚’æ›´æ–°
    imageHooks.handleImageHistoryRefresh();
  };

  // âœï¸ ç”»åƒç·¨é›†æˆåŠŸå¾Œã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆå±¥æ­´æ›´æ–°ä»˜ãï¼‰
  const handleImageEditWithRefresh = async () => {
    await editHooks.handleImageEdit();
    // ç”»åƒç·¨é›†ãŒæˆåŠŸã—ãŸã‚‰å±¥æ­´ã‚’æ›´æ–°
    imageHooks.handleImageHistoryRefresh();
  };

  // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã‘ã‚Œã°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  if (!isAuthenticated) {
    return (
      <div className="modal-overlay">
        <div className="modal-content">
          <h2>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã ã‚ˆï¼</h2>
          <p>ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ã†ã«ã¯Microsoft Entra IDã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼</p>
          <button 
            className="login-modal-btn" 
            onClick={() => instance.loginPopup()}
          >
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      </div>
    );
  }

  // ãƒ¡ã‚¤ãƒ³UI
  return (
    <div className="app-container">
      {/* ğŸ›ï¸ ãƒ¢ãƒ€ãƒ³ãªãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ãƒ– */}
      <div className="app-header">
        <div className="mode-tabs">
          <button
            className={`mode-tab ${currentMode === 'image-generation' ? 'active' : ''}`}
            onClick={() => setCurrentMode('image-generation')}
          >
            ğŸ­ ç”»åƒç”Ÿæˆ
          </button>
          <button
            className={`mode-tab ${currentMode === 'image-edit' ? 'active' : ''}`}
            onClick={() => setCurrentMode('image-edit')}
          >
            ğŸ–¼ï¸ ç”»åƒç·¨é›†
          </button>
          <button
            className={`mode-tab ${currentMode === 'video-generation' ? 'active' : ''}`}
            onClick={() => setCurrentMode('video-generation')}
          >
            ğŸ¬ å‹•ç”»ç”Ÿæˆ
          </button>
        </div>
      </div>

      {/* ğŸ“± ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */}
      <div className="main-content">
        {/* å·¦å´ï¼šå„ãƒ¢ãƒ¼ãƒ‰ã®ãƒ‘ãƒãƒ« */}
        <div className="left">
          {currentMode === 'image-generation' && (
            <ImageGenerationPanel
              prompt={imageHooks.prompt}
              setPrompt={imageHooks.setPrompt}
              originalPrompt={imageHooks.originalPrompt}
              size={imageHooks.size}
              setSize={imageHooks.setSize}
              loading={imageHooks.loading}
              loadingRec={imageHooks.loadingRec}
              recommendedPrompt={imageHooks.recommendedPrompt}
              cameraSettings={imageHooks.cameraSettings}
              setCameraSettings={imageHooks.setCameraSettings}
              onImageGenerate={handleImageGenerateWithRefresh}
              onGenerateRecommended={imageHooks.generateRecommendedPrompt}
              onUseRecommendedPrompt={imageHooks.useRecommendedPrompt}
            />
          )}
          
          {currentMode === 'image-edit' && (
            <ImageEditPanel
              editPrompt={editHooks.editPrompt}
              setEditPrompt={editHooks.setEditPrompt}
              uploadedImage={editHooks.uploadedImage}
              editedImage={editHooks.editedImage}
              loading={editHooks.loading}
              detectedSize={editHooks.detectedSize}
              canvasRef={editHooks.canvasRef}
              isDrawing={editHooks.isDrawing}
              hasMask={editHooks.hasMask}
              onImageUpload={editHooks.handleImageUpload}
              onImageEdit={handleImageEditWithRefresh}
              onResetEdit={editHooks.resetEdit}
              startDrawing={editHooks.startDrawing}
              draw={editHooks.draw}
              stopDrawing={editHooks.stopDrawing}
              clearMask={editHooks.clearMask}
            />
          )}
          
          {currentMode === 'video-generation' && (
            <VideoGenerationPanel
              videoPrompt={videoHooks.videoPrompt}
              setVideoPrompt={videoHooks.setVideoPrompt}
              videoAspectRatio={videoHooks.videoAspectRatio}
              setVideoAspectRatio={videoHooks.setVideoAspectRatio}
              videoResolution={videoHooks.videoResolution}
              setVideoResolution={videoHooks.setVideoResolution}
              videoDuration={videoHooks.videoDuration}
              setVideoDuration={videoHooks.setVideoDuration}
              videoVariation={videoHooks.videoVariation}
              setVideoVariation={videoHooks.setVideoVariation}
              videoLoading={videoHooks.videoLoading}
              loadingRec={videoHooks.loadingRec}
              recommendedPrompt={videoHooks.recommendedPrompt}
              onVideoGenerate={videoHooks.handleVideoGenerate}
              onGenerateRecommended={videoHooks.generateRecommendedVideo}
              onUseRecommendedPrompt={videoHooks.useRecommendedPrompt}
            />
          )}

          {/* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */}
          <div className="result-area">
            {/* ç”»åƒç”Ÿæˆçµæœ */}
            {currentMode === 'image-generation' && imageHooks.generatedImage && (
              <div className="generated-image-section">
                <h3>âœ¨ ç”Ÿæˆã•ã‚ŒãŸç”»åƒ</h3>
                <img src={imageHooks.generatedImage} alt="ç”Ÿæˆã•ã‚ŒãŸç”»åƒ" className="generated-image" />
              </div>
            )}
            
            {/* ç”»åƒç·¨é›†çµæœ */}
            {currentMode === 'image-edit' && editHooks.editedImage && (
              <div className="edited-image-section">
                <h3>ğŸ¨ ç·¨é›†çµæœ</h3>
                <img src={editHooks.editedImage} alt="ç·¨é›†ã•ã‚ŒãŸç”»åƒ" className="edited-image" />
              </div>
            )}

            {/* é¸æŠä¸­ã®ç”»åƒè¡¨ç¤º */}
            {(currentMode === 'image-generation' || currentMode === 'image-edit') && imageHooks.selectedImage && (
              <div className="selected-image-section">
                <div className="image-player-header">
                  <h3>ğŸ–¼ï¸ é¸æŠä¸­ã®ç”»åƒ</h3>
                  <button 
                    className="close-btn"
                    onClick={() => imageHooks.handleImageSelect(null)}
                    title="ç”»åƒãƒ“ãƒ¥ãƒ¼ã‚¢ã‚’é–‰ã˜ã‚‹"
                  >
                    âœ•
                  </button>
                </div>
                <div className="large-image-container">
                  <img 
                    src={imageHooks.selectedImage.imageUrl} 
                    alt={imageHooks.selectedImage.prompt}
                    className="large-image"
                  />
                  <div className="large-image-info">
                    <div className="image-prompt">
                      <strong>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</strong> {imageHooks.selectedImage.prompt}
                    </div>
                    <div className="image-details">
                      ğŸ“ {imageHooks.selectedImage.size} â€¢ 
                      {imageHooks.selectedImage.operationType === 'generate' ? 'ğŸ¨ ç”Ÿæˆ' : 'âœï¸ ç·¨é›†'} â€¢ 
                      ğŸ•’ {new Date(imageHooks.selectedImage.timestamp).toLocaleString()}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */}
            {currentMode === 'video-generation' && videoHooks.selectedVideo && (
              <div className="video-player-section">
                <div className="video-player-header">
                  <h3>â–¶ï¸ å†ç”Ÿä¸­ã®å‹•ç”»</h3>
                  <button 
                    className="close-btn"
                    onClick={() => videoHooks.handleVideoSelect(null)}
                    title="å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é–‰ã˜ã‚‹"
                  >
                    âœ•
                  </button>
                </div>
                <div className="large-video-player-container">
                  <video 
                    controls 
                    className="large-video-player"
                    key={videoHooks.selectedVideo.id}
                    autoPlay
                    style={{
                      width: '100%',
                      maxWidth: '100%',
                      height: 'auto',
                      borderRadius: '8px',
                      border: '2px solid #007acc'
                    }}
                  >
                    <source src={videoHooks.selectedVideo.videoUrl} type="video/mp4" />
                    ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                  </video>
                  <div className="large-video-player-info">
                    <div className="video-player-prompt">
                      <strong>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</strong> {videoHooks.selectedVideo.prompt}
                    </div>
                    <div className="video-player-details">
                      ğŸ“ {videoHooks.selectedVideo.videoSettings.width}Ã—{videoHooks.selectedVideo.videoSettings.height} â€¢ 
                      â±ï¸ {videoHooks.selectedVideo.videoSettings.n_seconds}ç§’
                      {videoHooks.selectedVideo.metadata.fileSize && ` â€¢ ğŸ“¦ ${(videoHooks.selectedVideo.metadata.fileSize / 1024 / 1024).toFixed(1)}MB`}
                    </div>
                    <div className="video-player-actions">
                      <button 
                        className="download-btn"
                        onClick={async () => {
                          try {
                            const token = await videoHooks.getAuthToken();
                            if (!token) {
                              throw new Error('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                            }
                            
                            const response = await fetch(`/api/downloadVideo/${videoHooks.selectedVideo!.id}`, {
                              method: 'GET',
                              headers: {
                                'Authorization': `Bearer ${token}`
                              }
                            });

                            if (!response.ok) {
                              throw new Error(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                            }

                            const contentDisposition = response.headers.get('content-disposition');
                            let filename = `video_${videoHooks.selectedVideo!.id}.mp4`;
                            if (contentDisposition) {
                              const matches = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                              if (matches && matches[1]) {
                                filename = matches[1].replace(/['"]/g, '');
                              }
                            }

                            const blob = await response.blob();
                            const downloadUrl = URL.createObjectURL(blob);
                            
                            const link = document.createElement('a');
                            link.href = downloadUrl;
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            
                            document.body.removeChild(link);
                            URL.revokeObjectURL(downloadUrl);
                            
                          } catch (error) {
                            console.error('âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                            const errorMessage = error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                            alert(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}`);
                          }
                        }}
                        title="å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                      >
                        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* å‹•ç”»ã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆ */}
            {currentMode === 'video-generation' && (
              <div className="video-jobs-section">
                <div className="video-jobs-panel">
                  <div className="video-jobs-header">
                    <h3>ğŸš€ å‹•ç”»ã‚¸ãƒ§ãƒ–</h3>
                    <button 
                      onClick={videoHooks.handleVideoJobsRefresh} 
                      className="refresh-btn"
                    >
                      â†» æ›´æ–°
                    </button>
                  </div>
                  
                  {videoHooks.activeVideoJobs.length === 0 ? (
                    <div className="empty-state">
                      å‹•ç”»ã‚¸ãƒ§ãƒ–ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                  ) : (
                    <div className="jobs-list">
                      {videoHooks.activeVideoJobs.map((job: VideoJob) => (
                        <div key={job.id} className="job-item">
                          <div className="job-content">
                            <div className="job-main">
                              <div className="job-status">
                                {job.status === 'pending' && 'â³'}
                                {job.status === 'running' && 'ğŸ”„'}
                                {job.status === 'completed' && 'âœ…'}
                                {job.status === 'succeeded' && 'âœ…'}
                                {job.status === 'failed' && 'âŒ'}
                                {job.status === 'cancelled' && 'ğŸš«'}
                                {' '}{job.status}
                              </div>
                              <div className="job-prompt">
                                {job.prompt.length > 50 ? `${job.prompt.substring(0, 50)}...` : job.prompt}
                              </div>
                              <div className="job-details">
                                {job.videoSettings.width}Ã—{job.videoSettings.height} â€¢ 
                                {job.videoSettings.n_seconds}ç§’ â€¢ 
                                {job.startTime.toLocaleTimeString()}
                              </div>
                              
                              {/* å®Œæˆã—ãŸã‚¸ãƒ§ãƒ–ã«å‡¦ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */}
                              {(job.status === 'completed' || job.status === 'succeeded') && (
                                <div className="job-actions">
                                  <button 
                                    className="process-btn"
                                    onClick={() => videoHooks.handleProcessCompletedJobWithDelete(job)}
                                  >
                                    ğŸ“¥ å–ã‚Šè¾¼ã¿
                                  </button>
                                  <button 
                                    className="delete-job-btn"
                                    onClick={() => videoHooks.handleDeleteVideoJob(job)}
                                  >
                                    ğŸ—‘ï¸ å‰Šé™¤
                                  </button>
                                </div>
                              )}
                              
                              {/* å®Ÿè¡Œä¸­ãƒ»å¾…æ©Ÿä¸­ã®ã‚¸ãƒ§ãƒ–ã«ã‚‚å‰Šé™¤ãƒœã‚¿ãƒ³ */}
                              {(job.status === 'running' || job.status === 'pending') && (
                                <div className="job-actions">
                                  <button 
                                    className="cancel-job-btn"
                                    onClick={() => videoHooks.handleDeleteVideoJob(job)}
                                  >
                                    â¹ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                  </button>
                                </div>
                              )}
                              
                              {/* å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã«ã‚‚å‰Šé™¤ãƒœã‚¿ãƒ³ */}
                              {job.status === 'failed' && (
                                <div className="job-actions">
                                  <button 
                                    className="delete-job-btn"
                                    onClick={() => videoHooks.handleDeleteVideoJob(job)}
                                  >
                                    ğŸ—‘ï¸ å‰Šé™¤
                                  </button>
                                </div>
                              )}
                            </div>
                            
                            {/* ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º */}
                            {job.thumbnailUrl && (
                              <div className="job-thumbnail">
                                <img 
                                  src={job.thumbnailUrl} 
                                  alt="Video thumbnail"
                                  style={{
                                    width: '80px',
                                    height: '60px',
                                    objectFit: 'cover',
                                    borderRadius: '4px',
                                    border: '1px solid #ddd'
                                  }}
                                />
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
        
        {/* å³å´ï¼šå±¥æ­´ãƒ‘ãƒãƒ« */}
        <div className="right">
          {(currentMode === 'image-generation' || currentMode === 'image-edit') && (
            <ImageHistoryPanel
              imageHistory={imageHooks.imageHistory}
              selectedImage={imageHooks.selectedImage}
              loading={imageHooks.imageHistoryLoading}
              onRefresh={imageHooks.handleImageHistoryRefresh}
              onImageSelect={imageHooks.handleImageSelect}
              onImageDelete={imageHooks.handleImageDelete}
            />
          )}
          
          {currentMode === 'video-generation' && (
            <VideoHistoryPanel
              videoHistory={videoHooks.videoHistory}
              activeVideoJobs={[]} // å³ãƒšã‚¤ãƒ³ã§ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¸ãƒ§ãƒ–ã‚’è¡¨ç¤ºã—ãªã„
              selectedVideo={videoHooks.selectedVideo}
              onVideoSelect={videoHooks.handleVideoSelect}
              onRefresh={videoHooks.handleVideoHistoryRefresh}
              loading={videoHooks.videoHistoryLoading}
            />
          )}
        </div>
      </div>
    </div>
  );
}

function App() {
  return (
    <MsalProvider instance={msalInstance}>
      <AuthButtons />
      <AppContent />
    </MsalProvider>
  );
}

export default App;