// App.tsx - å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ + ã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆæ”¹è‰¯ç‰ˆ
import React from 'react';
import { MsalProvider, useMsal, useIsAuthenticated } from '@azure/msal-react';
import { PublicClientApplication } from '@azure/msal-browser';
import { msalConfig } from './msalConfig';
import { useVideoGeneration } from './hooks/useVideoGeneration';
import { VideoJob } from './types';
import VideoGenerationPanel from './components/VideoGenerationPanel';
import VideoHistoryPanel from './VideoHistoryPanel';
import './App.css';

const msalInstance = new PublicClientApplication(msalConfig);

function AuthButtons() {
  const { instance } = useMsal();
  const isAuthenticated = useIsAuthenticated();

  if (isAuthenticated) {
    return (
      <div style={{ 
        position: 'absolute', 
        top: '10px', 
        right: '10px', 
        zIndex: 1000 
      }}>
        <button 
          onClick={() => instance.logoutPopup()}
          style={{
            padding: '8px 16px',
            backgroundColor: '#d32f2f',
            color: 'white',
            border: 'none',
            borderRadius: '4px',
            cursor: 'pointer'
          }}
        >
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </button>
      </div>
    );
  }

  return null;
}

function AppContent() {
  const isAuthenticated = useIsAuthenticated();
  const { instance } = useMsal();

  // ğŸ¬ å‹•ç”»ç”Ÿæˆé–¢é€£ã®hookã‚’ä½¿ç”¨
  const {
    // State
    videoPrompt,
    setVideoPrompt,
    videoAspectRatio,
    setVideoAspectRatio,
    videoResolution,
    setVideoResolution,
    videoDuration,
    setVideoDuration,
    videoVariation,
    setVideoVariation,
    videoHistory,
    activeVideoJobs,
    selectedVideo,
    videoLoading,
    videoHistoryLoading,
    recommendedPrompt,
    loadingRec,
    
    // Actions
    handleVideoGenerate,
    handleVideoSelect,
    handleVideoHistoryRefresh,
    handleVideoJobsRefresh,
    handleProcessCompletedJobWithDelete,
    handleDeleteVideoJob,
    generateRecommendedVideo,
    useRecommendedPrompt,
    
    // Auth
    getAuthToken,
  } = useVideoGeneration();

  // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã‘ã‚Œã°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  if (!isAuthenticated) {
    return (
      <div className="modal-overlay">
        <div className="modal-content">
          <h2>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã ã‚ˆï¼</h2>
          <p>ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ã†ã«ã¯Microsoft Entra IDã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã­ï¼</p>
          <button 
            className="login-modal-btn" 
            onClick={() => instance.loginPopup()}
          >
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </div>
      </div>
    );
  }

  // ãƒ¡ã‚¤ãƒ³UI
  return (
    <div className="container">
      {/* å·¦å´: å‹•ç”»ç”Ÿæˆãƒ‘ãƒãƒ« + å‹•ç”»ã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆ + å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */}
      <div className="left">
        <VideoGenerationPanel
          videoPrompt={videoPrompt}
          setVideoPrompt={setVideoPrompt}
          videoAspectRatio={videoAspectRatio}
          setVideoAspectRatio={setVideoAspectRatio}
          videoResolution={videoResolution}
          setVideoResolution={setVideoResolution}
          videoDuration={videoDuration}
          setVideoDuration={setVideoDuration}
          videoVariation={videoVariation}
          setVideoVariation={setVideoVariation}
          videoLoading={videoLoading}
          loadingRec={loadingRec}
          recommendedPrompt={recommendedPrompt}
          onVideoGenerate={handleVideoGenerate}
          onGenerateRecommended={generateRecommendedVideo}
          onUseRecommendedPrompt={useRecommendedPrompt}
        />

        {/* ä¸‹å´: å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆã®2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */}
        <div className="bottom">
          <div className="bottom-content">
            {/* å·¦å´: å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */}
            {selectedVideo && (
              <div className="video-player-section">
                <div className="video-player-header">
                  <h3>â–¶ï¸ å†ç”Ÿä¸­ã®å‹•ç”»</h3>
                  <button 
                    className="close-btn"
                    onClick={() => handleVideoSelect(null)}
                    title="å‹•ç”»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é–‰ã˜ã‚‹"
                  >
                    âœ•
                  </button>
                </div>
                <div className="large-video-player-container">
                  <video 
                    controls 
                    className="large-video-player"
                    key={selectedVideo.id}
                    autoPlay
                    style={{
                      width: '100%',
                      maxWidth: '100%',
                      height: 'auto',
                      borderRadius: '8px',
                      border: '2px solid #007acc'
                    }}
                  >
                    <source src={selectedVideo.videoUrl} type="video/mp4" />
                    ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»å†ç”Ÿã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                  </video>
                  <div className="large-video-player-info">
                    <div className="video-player-prompt">
                      <strong>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</strong> {selectedVideo.prompt}
                    </div>
                    <div className="video-player-details">
                      ğŸ“ {selectedVideo.videoSettings.width}Ã—{selectedVideo.videoSettings.height} â€¢ 
                      â±ï¸ {selectedVideo.videoSettings.n_seconds}ç§’
                      {selectedVideo.metadata.fileSize && ` â€¢ ğŸ“¦ ${(selectedVideo.metadata.fileSize / 1024 / 1024).toFixed(1)}MB`}
                    </div>
                    <div className="video-player-actions">
                      <button 
                        className="download-btn"
                        onClick={async () => {
                          console.log('ğŸ¯ å¤§ããªãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼', selectedVideo.id);
                          
                          try {
                            // MSALã‹ã‚‰èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
                            const token = await getAuthToken();
                            console.log('ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚§ãƒƒã‚¯:', token ? 'âœ… ã‚ã‚Š' : 'âŒ ãªã—');
                            
                            if (!token) {
                              throw new Error('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                            }
                            
                            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰APIã‚’å‘¼ã³å‡ºã—
                            const response = await fetch(`/api/downloadVideo/${selectedVideo.id}`, {
                              method: 'GET',
                              headers: {
                                'Authorization': `Bearer ${token}`
                              }
                            });

                            console.log('ğŸ“¡ API ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status, response.statusText);

                            if (!response.ok) {
                              throw new Error(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                            }

                            // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
                            const contentDisposition = response.headers.get('content-disposition');
                            let filename = `video_${selectedVideo.id}.mp4`;
                            if (contentDisposition) {
                              const matches = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                              if (matches && matches[1]) {
                                filename = matches[1].replace(/['"]/g, '');
                              }
                            }

                            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’Blobã¨ã—ã¦å–å¾—
                            const blob = await response.blob();
                            
                            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®URLã‚’ä½œæˆ
                            const downloadUrl = URL.createObjectURL(blob);
                            
                            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
                            const link = document.createElement('a');
                            link.href = downloadUrl;
                            link.download = filename;
                            document.body.appendChild(link);
                            link.click();
                            
                            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                            document.body.removeChild(link);
                            URL.revokeObjectURL(downloadUrl);

                            console.log('âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ:', filename);
                            
                          } catch (error) {
                            console.error('âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                            const errorMessage = error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                            alert(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMessage}`);
                          }
                        }}
                        title="å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                      >
                        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* å³å´: å‹•ç”»ã‚¸ãƒ§ãƒ–ãƒªã‚¹ãƒˆï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ */}
            <div className={`video-jobs-section ${selectedVideo ? 'with-player' : 'without-player'}`}>
              <div className="video-jobs-panel">
                <div className="video-jobs-header">
                  <h3>ğŸš€ å‹•ç”»ã‚¸ãƒ§ãƒ–</h3>
                  <button 
                    onClick={handleVideoJobsRefresh} 
                    className="refresh-btn"
                  >
                    â†» æ›´æ–°
                  </button>
                </div>
                
                {activeVideoJobs.length === 0 ? (
                  <div className="empty-state">
                    å‹•ç”»ã‚¸ãƒ§ãƒ–ãŒã‚ã‚Šã¾ã›ã‚“
                  </div>
                ) : (
                  <div className="jobs-list">
                    {activeVideoJobs.map((job: VideoJob) => (
                      <div key={job.id} className="job-item">
                        <div className="job-content">
                          <div className="job-main">
                            <div className="job-status">
                              {job.status === 'pending' && 'â³'}
                              {job.status === 'running' && 'ğŸ”„'}
                              {job.status === 'completed' && 'âœ…'}
                              {job.status === 'succeeded' && 'âœ…'}
                              {job.status === 'failed' && 'âŒ'}
                              {job.status === 'cancelled' && 'ğŸš«'}
                              {' '}{job.status}
                            </div>
                            <div className="job-prompt">
                              {job.prompt.length > 50 ? `${job.prompt.substring(0, 50)}...` : job.prompt}
                            </div>
                            <div className="job-details">
                              {job.videoSettings.width}Ã—{job.videoSettings.height} â€¢ 
                              {job.videoSettings.n_seconds}ç§’ â€¢ 
                              {job.startTime.toLocaleTimeString()}
                            </div>
                            
                            {/* å®Œæˆã—ãŸã‚¸ãƒ§ãƒ–ã«å‡¦ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º */}
                            {(job.status === 'completed' || job.status === 'succeeded') && (
                              <div className="job-actions">
                                <button 
                                  className="process-btn"
                                  onClick={() => handleProcessCompletedJobWithDelete(job)}
                                >
                                  ğŸ“¥ å–ã‚Šè¾¼ã¿
                                </button>
                                <button 
                                  className="delete-job-btn"
                                  onClick={() => handleDeleteVideoJob(job)}
                                >
                                  ğŸ—‘ï¸ å‰Šé™¤
                                </button>
                              </div>
                            )}
                            
                            {/* å®Ÿè¡Œä¸­ãƒ»å¾…æ©Ÿä¸­ã®ã‚¸ãƒ§ãƒ–ã«ã‚‚å‰Šé™¤ãƒœã‚¿ãƒ³ */}
                            {(job.status === 'running' || job.status === 'pending') && (
                              <div className="job-actions">
                                <button 
                                  className="cancel-job-btn"
                                  onClick={() => handleDeleteVideoJob(job)}
                                >
                                  â¹ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                              </div>
                            )}
                            
                            {/* å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã«ã‚‚å‰Šé™¤ãƒœã‚¿ãƒ³ */}
                            {job.status === 'failed' && (
                              <div className="job-actions">
                                <button 
                                  className="delete-job-btn"
                                  onClick={() => handleDeleteVideoJob(job)}
                                >
                                  ğŸ—‘ï¸ å‰Šé™¤
                                </button>
                              </div>
                            )}
                          </div>
                          
                          {/* ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º */}
                          {job.thumbnailUrl && (
                            <div className="job-thumbnail">
                              <img 
                                src={job.thumbnailUrl} 
                                alt="Video thumbnail"
                                style={{
                                  width: '80px',
                                  height: '60px',
                                  objectFit: 'cover',
                                  borderRadius: '4px',
                                  border: '1px solid #ddd'
                                }}
                              />
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {/* å³å´: å‹•ç”»å±¥æ­´ï¼ˆCosmos DBã‹ã‚‰ï¼‰ */}
      <div className="right">
        <VideoHistoryPanel
          videoHistory={videoHistory}
          activeVideoJobs={[]} // å³ãƒšã‚¤ãƒ³ã§ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¸ãƒ§ãƒ–ã‚’è¡¨ç¤ºã—ãªã„
          selectedVideo={selectedVideo}
          onVideoSelect={handleVideoSelect}
          onRefresh={handleVideoHistoryRefresh}
          loading={videoHistoryLoading}
        />
      </div>
    </div>
  );
}

function App() {
  return (
    <MsalProvider instance={msalInstance}>
      <AuthButtons />
      <AppContent />
    </MsalProvider>
  );
}

export default App;
